<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Binance Signal Group — Admin-Only Chat + Members (100 Countries) + Profit Cards (Real Prices)</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://db.onlinewebfonts.com/c/d05c19ccecf7003d248c60ffd6b5e8f7?family=Binance+PLEX" rel="stylesheet"/>

<style>
  :root{
    --bg:#0b0f14; --panel:#0f1621; --panel2:#0b1320; --ink:#e6eef7; --muted:#9eb1c7;
    --line:#1a2736; --accent:#fcd535; --up:#16a34a; --down:#ef4444;
    --online:#10b981; --offline:#6b7280;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
  .wrap{display:grid; grid-template-rows:auto 1fr auto; height:100vh;}
  header{display:flex; align-items:center; gap:16px; padding:14px 18px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#111827, #0b0f14 70%);} 
  .logo{width:36px; height:36px; border-radius:10px; background:radial-gradient(circle at 30% 30%, #ffd84d, #b99000); display:grid; place-items:center; font-weight:800; color:#111;}
  header h1{margin:0; font-size:18px; font-weight:700; letter-spacing:0.2px}
  header .sub{color:var(--muted); font-size:12px}
  .stats{margin-left:auto; display:flex; align-items:center; gap:22px}
  .stat{display:flex; flex-direction:column; align-items:flex-end}
  .stat .v{font-size:18px; font-weight:700}
  .segments{display:flex; gap:4px; align-items:center}
  .seg{width:22px; height:8px; border-radius:3px; background:#263446; outline:1px solid #1e2a39}
  .seg.fill{background:var(--accent)}
  .seg.half{background:linear-gradient(90deg, var(--accent) 50%, #263446 50%)}
  main{display:grid; grid-template-columns:1fr 330px; gap:0; min-height:0;}
  .chat{display:flex; flex-direction:column; min-height:0;}
  .chat-head{display:flex; gap:10px; align-items:center; padding:10px 16px; border-bottom:1px solid var(--line); background:var(--panel2)}
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; background:#152235; color:var(--muted); border:1px solid #1f3047}
  .chat-scroll{flex:1; overflow:auto; padding:16px; background:radial-gradient(1200px 400px at 20% -10%, rgba(252,213,53,0.06), transparent 50%), linear-gradient(180deg, #0c1118, #0b0f14)}
  .bub{max-width:70%; margin:10px 0; padding:12px 14px; border-radius:14px; line-height:1.35; font-size:14px; border:1px solid #213149}
  .bub.admin{margin-left:auto; background:#0f1b2c}
  .bub .meta{font-size:11px; color:var(--muted); margin-top:6px}
  .bub img{max-width:100%; border-radius:10px; margin-top:8px; display:block}
  .composer{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; padding:10px; background:var(--panel); border-top:1px solid var(--line)}
  .composer input[type="text"]{width:100%; background:#0d1522; border:1px solid #1f2a39; color:var(--ink); border-radius:10px; padding:12px 12px; outline:none}
  .composer input[type="file"]{display:none}
  .btn{background:var(--accent); color:#111; border:0; padding:10px 14px; font-weight:700; border-radius:10px; cursor:pointer}
  .btn:disabled{opacity:.4; cursor:not-allowed}
  .attach{background:#162236; color:#e6eef7; border:1px dashed #2a3a52; padding:8px 12px; border-radius:10px; cursor:pointer}
  .attach small{color:var(--muted)}
  .role{margin-left:8px;}
  .role label{font-size:12px; color:var(--muted)}

  /* Right members panel */
  aside{border-left:1px solid var(--line); background:linear-gradient(180deg, #0d1421, #0b0f14); display:flex; flex-direction:column; min-height:0}
  .aside-head{padding:12px; border-bottom:1px solid var(--line); display:grid; gap:10px}
  .search{display:flex; gap:8px}
  .search input{flex:1; background:#0d1522; border:1px solid #1f2a39; color:#e6eef7; border-radius:10px; padding:10px}
  .members{overflow:auto; padding:8px 8px 14px}
  .row{
    display:grid; grid-template-columns:36px 1fr auto; gap:10px; align-items:center;
    padding:8px; border-radius:12px; border:1px solid #1b2740; background:#0d1626; margin-bottom:8px
  }
  .av{
    width:36px; height:36px; border-radius:10px; display:grid; place-items:center; font-weight:800;
    background:linear-gradient(135deg,#1f2a40,#0e1726); color:#e6eef7; border:1px solid #213149; letter-spacing:.3px;
  }
  .name{font-weight:600; font-size:13px}
  .status{
    display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:600; padding:4px 8px; border-radius:999px;
    border:1px solid #1e2a39; background:#0b1320; color:#cfd8e3;
  }
  .dot{width:8px; height:8px; border-radius:999px; display:inline-block}
  .online .dot{background:var(--online)}
  .offline .dot{background:var(--offline)}
  .loadmore{margin:8px;}

  @media (max-width: 980px){
    main{grid-template-columns:1fr}
    aside{order:-1}
  }

  /* --- OLD Profit Card (unchanged) --- */
  .pcard{
    max-width:300px; width:min(90vw,300px);
    background:url('https://iili.io/KKAe9kv.md.gif') center/cover no-repeat;
    color:#fff; border-radius:10px; padding:0.5cm 14px; position:relative; overflow:hidden;
    box-shadow:0 8px 40px rgba(0,0,0,.45);
    font-family:"Binance PLEX","Segoe UI",Arial,sans-serif;
    font-variant-numeric:tabular-nums;
  }
  .pcard .inner{ transform:translateX(0.55cm); }
  .pcard .header{ display:flex; align-items:flex-start; gap:4px; margin-bottom:0.35cm; transform:translateX(-0.5cm); }
  .pcard .binance-logo{ width:11px; height:11px; margin-top:-1px; }
  .pcard .text-block{ display:flex; flex-direction:column; margin-top:-1px; }
  .pcard .binance-text{ font-weight:800; font-size:.45rem; color:#f0b90b; letter-spacing:.25px; }
  .pcard .futures-text{ font-size:.5rem; color:#fff; font-weight:700; line-height:1; }
  .pcard .trade-info{ margin:4px 0; font-size:.45rem; font-weight:600; display:flex; gap:0.25cm; }
  .pcard .short{ color:#ff4d6b; } .pcard .long{ color:#00c292; }
  .pcard .percentage{ font-size:1.2rem; font-weight:900; margin:5px 0; }
  .pcard .percentage.green{ color:#00c292; font-size:1.35rem; }
  .pcard .percentage.red{ color:#ff4d6b; }
  .pcard .price-section{ margin:5px 0 6px; }
  .pcard .price-line{ display:flex; justify-content:flex-start; gap:5px; margin-bottom:2px; }
  .pcard .price-label{ color:#ccc; font-size:.45rem; width:65px; font-weight:700; }
  .pcard .price-value{ color:#f0b90b; font-weight:800; font-size:.55rem; margin-left:12px; }
  .pcard .referral-section{ display:flex; align-items:center; gap:6px; margin-top:0.25cm; }
  .pcard .qr{ width:24px; height:24px; border-radius:4px; border:1px solid rgba(255,255,255,.18); object-fit:cover; }
  .pcard .ref-text{ font-size:.42rem; color:#ddd; font-weight:600; }
  .pcard .referral-code{ font-weight:800; font-size:.55rem; letter-spacing:.2px; }
  .pcard .app-text{ font-size:.42rem; color:#f0b90b; margin-top:0; font-weight:700; }

  /* --- NEW Profit Card (>= 2025-07-25) --- */
  .nx-card{
    width:320px;
    border-radius:16px; overflow:hidden;
    background:#111 url("https://iili.io/KBlgIse.th.png") center/cover no-repeat;
    border:2px solid #2e2e2e; box-shadow:0 8px 24px rgba(0,0,0,.45);
    color:#fff; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .nx-header{ padding:16px; display:flex; align-items:center; gap:12px; margin-bottom:calc(16px + 1cm); }
  .nx-av{
    width:40px; height:40px; aspect-ratio:1/1;
    border-radius:50%; overflow:hidden; flex:0 0 40px;
    box-shadow:0 0 0 2px rgba(255,255,255,.08);
    display:grid; place-items:center; background:#000;
    --av-shift:-6px;
  }
  .nx-av img{ width:100%; height:100%; display:block; object-fit:cover; object-position:center; border-radius:50%; transform:translateY(var(--av-shift)); }
  .nx-user{ display:flex; flex-direction:column; line-height:1.1; }
  .nx-user .nx-name{ font-weight:600; font-size:15px; }
  .nx-user .nx-time{ font-size:11px; opacity:.9; }
  .nx-body{ padding:0 16px calc(20px + 1cm); }
  .nx-title{ font-size:16px; font-weight:800; text-transform:uppercase; letter-spacing:.2px; }
  .nx-pos{ margin:6px 0 10px; display:inline-flex; align-items:center; gap:10px; font-size:13px; font-weight:600; }
  .nx-pos .nx-short{ color:#ff6b6b; } .nx-pos .nx-long{ color:#0ecb81; }
  .nx-div{ width:1px; height:12px; background:#6a6a6a; display:inline-block; }
  .nx-lev{ color:#cfcfcf; }

  /* value line: will show EITHER USDT PnL or ROI% in big font */
  .nx-pnl{ display:flex; align-items:baseline; gap:8px; margin:6px 0 8px; }
  .nx-usd, .nx-roi{ font-size:32px; font-weight:800; letter-spacing:-.4px; }
  .nx-u, .nx-percent{ font-size:16px; font-weight:700; }
  .posG{ color:#0ecb81; } .posR{ color:#ff6b6b; }

  .nx-prices{ position:relative; display:flex; justify-content:space-between; gap:16px; font-size:12px; }
  .nx-label{ color:#9a9a9a; font-size:11px; }
  .nx-value{ color:#fff; }
  .nx-last{ position:relative; left:-2.6cm; }
  .nx-foot{ background:#000; }
  .nx-line{ display:block; height:1px; width:100%; background:#444; }
  .nx-footc{ padding:14px 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .nx-id{ display:grid; grid-template-columns:auto 1fr; grid-template-rows:auto auto auto; column-gap:8px; row-gap:2px; align-items:center; margin-left:-6px; }
  .nx-logo{ grid-column:1/2; grid-row:1/2; width:16px; height:16px; display:block; position:relative; left:6px; top:-0.2cm; }
  .nx-logo img{ width:100%; height:100%; object-fit:contain; display:block; }
  .nx-brand{ grid-column:2/3; grid-row:1/2; font-family:"Binance PLEX", Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#fcd535; font-weight:900; font-size:11px; line-height:1; letter-spacing:.2px; text-transform:uppercase; }
  .nx-futures{ grid-column:2/3; grid-row:2/3; font-size:14px; line-height:1; font-weight:800; text-transform:uppercase; color:#eaeaea; }
  .nx-ref{ grid-column:2/3; grid-row:3/4; font-size:11px; line-height:1.1; color:#ffffff; letter-spacing:.1px; }
  .nx-qr{
    width:62px; height:62px; background:#fff; border-radius:6px; overflow:hidden; display:block;
    box-shadow:inset 0 0 0 1px #e5e5e5; position:relative;
    --qr-shift:-8px;
  }
  .nx-qr img{ width:100%; height:100%; object-fit:cover; transform:translateY(var(--qr-shift)); display:block; }

  .admintools{display:flex; gap:8px; align-items:center; padding:8px; border-top:1px dashed #263446; background:#0f1621}
  .admintools input, .admintools select{background:#0d1522; border:1px solid #1f2a39; color:#e6eef7; border-radius:8px; padding:8px}
  .admintools .btn{padding:8px 12px}
  .muted{color:#9eb1c7; font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">B</div>
    <div>
      <h1>Binance Signal Group</h1>
      <div class="sub">Admin-only chat • Valid-countries member directory (≈100 countries)</div>
    </div>
    <div class="stats">
      <div class="stat">
        <div class="v" id="totalMembers">—</div>
        <small class="sub">Total Members (800K – 850K)</small>
      </div>
      <div class="stat">
        <div class="segments" id="segments"></div>
        <small class="sub">Laksha breakdown (8.x)</small>
      </div>
    </div>
  </header>

  <main>
    <!-- Chat Area -->
    <section class="chat">
      <div class="chat-head">
        <span class="pill">Admin Chat</span>
        <span class="pill">Only admin can send</span>
        <div class="role">
          <label><input type="checkbox" id="viewAsMember"> View as member (disable sending)</label>
        </div>
      </div>
      <div class="chat-scroll" id="chatScroll">
        <div class="bub">
          👋 Welcome to the Binance Signal Group. Admin posts official updates here.
          <div class="meta">System • just now</div>
        </div>
      </div>
      <div class="composer">
        <label class="attach" for="fileInput">📷 Attach photo <small>(optional)</small></label>
        <input id="msg" type="text" placeholder="Type admin message…"/>
        <button class="btn" id="sendBtn">Send</button>
        <input id="fileInput" type="file" accept="image/*"/>
      </div>
    </section>

    <!-- Members Panel -->
    <aside>
      <div class="aside-head">
        <div class="search">
          <input id="search" placeholder="Search member by name…"/>
        </div>
        <small class="sub">Right panel: all members listed one by one. Use search to jump.</small>
      </div>
      <div class="members" id="members"></div>
      <button class="btn loadmore" id="loadMore">Load more</button>
    </aside>
  </main>
</div>

<script>
/* ============================================================
   MEMBERS + HEADER STATS (unchanged)
============================================================ */
function numberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function initialsFromName(full){
  const parts = full.trim().split(/\s+/);
  const f = parts[0]?.[0] || '';
  const l = parts[1]?.[0] || '';
  return (f + l).toUpperCase();
}

const members = [];
const seedCount = 1200;
const firsts = ['Alex','Mia','Omar','Yuki','Ishan','Sara','Leo','Noah','Ava','Ethan','Layla','Nina','Ivan','Luis','Aria','Kai','Hana','Zara','Milan','Nora'];
const lasts  = ['Chen','Silva','Khan','Perera','Singh','Kumar','Gomez','Ivanov','Lee','Nguyen','Hassan','Yilmaz','Costa','Santos','Hansen','Novak','Almeida','Park','Sato','Smith'];
for (let i=0;i<seedCount;i++){
  const name = `${pick(firsts)} ${pick(lasts)}`;
  const status = Math.random()<0.55 ? 'online' : 'offline';
  members.push({id:i+1, name, status});
}
const min = 800000, max = 850000;
const total = Math.floor(Math.random()*(max-min+1))+min;
document.getElementById('totalMembers').textContent = numberWithCommas(total);
const segmentsEl = document.getElementById('segments');
for(let i=0;i<8;i++){ const d = document.createElement('div'); d.className='seg fill'; segmentsEl.appendChild(d); }
const remainder = total - 800000;
if (remainder>0){
  const d = document.createElement('div');
  d.className = remainder>=50000? 'seg half':'seg';
  segmentsEl.appendChild(d);
}
const membersEl = document.getElementById('members');
const searchEl  = document.getElementById('search');
const loadMoreBtn = document.getElementById('loadMore');
let viewSlice = 0; const PAGE=60;
function renderMembers(){
  const q = searchEl.value.toLowerCase().trim();
  const filtered = members.filter(m => q ? m.name.toLowerCase().includes(q) : true);
  const toShow = filtered.slice(0, viewSlice);
  membersEl.innerHTML='';
  toShow.forEach(m=>{
    const row = document.createElement('div'); row.className='row';
    const init = initialsFromName(m.name);
    const badgeCls = m.status === 'online' ? 'online' : 'offline';
    row.innerHTML = `
      <div class="av" aria-hidden="true">${init}</div>
      <div><div class="name">${m.name}</div></div>
      <div class="status ${badgeCls}" title="${m.status === 'online' ? 'Online' : 'Offline'}">
        <span class="dot"></span>${m.status === 'online' ? 'Online' : 'Offline'}
      </div>`;
    membersEl.appendChild(row);
  });
  loadMoreBtn.style.display = (filtered.length>viewSlice)?'block':'none';
}
function resetAndRender(){ viewSlice = PAGE; renderMembers(); }
searchEl.addEventListener('input', resetAndRender);
loadMoreBtn.addEventListener('click', ()=>{ viewSlice += PAGE; renderMembers(); });
resetAndRender();

/* ============================================================
   ADMIN CHAT BASICS (unchanged)
============================================================ */
const chatScroll = document.getElementById('chatScroll');
const fileInput  = document.getElementById('fileInput');
const msgInput   = document.getElementById('msg');
const sendBtn    = document.getElementById('sendBtn');
const viewAsMember = document.getElementById('viewAsMember');
function setRoleUI(){ const memberMode = viewAsMember.checked; msgInput.disabled = memberMode; sendBtn.disabled = memberMode; }
setRoleUI(); viewAsMember.addEventListener('change', setRoleUI);
let attachedDataUrl = null;
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files[0];
  if(!f){attachedDataUrl=null; return}
  const r = new FileReader();
  r.onload = ()=>{attachedDataUrl = r.result;};
  r.readAsDataURL(f);
});
function addAdminMessage(text, img){
  const b = document.createElement('div'); b.className='bub admin';
  b.innerHTML = `${text ? text.replace(/</g,'&lt;') : ''}${img? `<img src="${img}" alt="attachment">`:''}<div class="meta">Admin • ${new Date().toLocaleString()}</div>`;
  chatScroll.appendChild(b); chatScroll.scrollTop = chatScroll.scrollHeight;
}
addAdminMessage('Today\'s BTC/USDT scalp plan: watch 1m/5m confluence near VWAP. SL tight, TP 2R.');
addAdminMessage('Upload proof or chart here if needed — admin can attach images to announcements.');
sendBtn.addEventListener('click', ()=>{
  if (viewAsMember.checked) return;
  const t = msgInput.value.trim(); if(!t && !attachedDataUrl) return;
  addAdminMessage(t, attachedDataUrl);
  msgInput.value=''; attachedDataUrl=null; fileInput.value='';
});
</script>

<script>
/* ============================================================
   PROFIT CARDS (REAL BINANCE FUTURES PRICES)
   - NEW: For dates >= 2025-07-25, “here & there” show ROI% (photo style)
     instead of USDT amount — while keeping all calculations correct.
============================================================ */
const API = {
  futuresKlines: 'https://fapi.binance.com/fapi/v1/klines',
  ping: 'https://fapi.binance.com/fapi/v1/ping'
};
const SYMBOLS = [
  'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','DOGEUSDT','ADAUSDT',
  'TONUSDT','AVAXUSDT','LINKUSDT','NEARUSDT','MATICUSDT','OPUSDT','ARBUSDT','ATOMUSDT'
];
const DOM_CAP = 500;
const ROI_RANGE = {min:300, max:3500}; // % inclusive
const CUTOFF_NEW = new Date('2025-07-25T00:00:00Z');

const BG_BASE = 'https://iili.io/KBlgIse.th.png';
const BG_ALT  = 'https://iili.io/KWFNXj4.th.png'; // your PNG
function pickNewBg(){ const bag = [BG_BASE, BG_BASE, BG_BASE, BG_ALT]; return bag[(Math.random()*bag.length)|0]; }

/* 60% ROI view, 40% USDT view */
function pickDisplayMode(){ return Math.random()<0.6 ? 'ROI' : 'USDT'; }

const CHAT = document.getElementById('chatScroll');

(function injectAdminTools(){
  const composer = document.querySelector('.composer');
  const bar = document.createElement('div');
  bar.className = 'admintools';
  bar.innerHTML = `
    <span class="muted">Profit Cards:</span>
    <label class="muted">Per day
      <input id="pcPerDay" type="number" min="1" max="200" value="100" style="width:70px">
    </label>
    <label class="muted">Leverage
      <select id="pcLev">
        <option>5</option><option>10</option><option selected>20</option><option>50</option><option>100</option>
      </select>x
    </label>
    <label class="muted">Side Mix
      <select id="pcSideMix">
        <option value="mixed" selected>Mixed</option>
        <option value="long">Long only</option>
        <option value="short">Short only</option>
      </select>
    </label>
    <label class="muted">Start
      <input id="pcStart" type="date">
    </label>
    <label class="muted">End
      <input id="pcEnd" type="date">
    </label>
    <button class="btn" id="pcGen20">Generate Sample (20)</button>
    <button class="btn" id="pcBackfill">Backfill 2 Years (Batched)</button>
    <button class="btn" id="pcExport">Export JSON</button>
  `;
  composer.parentNode.insertBefore(bar, composer);

  const today = new Date(); 
  const start = new Date(today); start.setDate(start.getDate()-730);
  bar.querySelector('#pcStart').value = start.toISOString().slice(0,10);
  bar.querySelector('#pcEnd').value = today.toISOString().slice(0,10);

  const getRange = ()=>({ start: new Date(bar.querySelector('#pcStart').value+'T00:00:00Z'), end: new Date(bar.querySelector('#pcEnd').value+'T00:00:00Z') });

  bar.querySelector('#pcGen20').addEventListener('click', async ()=>{
    await ensurePing();
    await generateCardsRandom(20, parseInt(bar.querySelector('#pcLev').value,10), bar.querySelector('#pcSideMix').value, getRange());
  });

  bar.querySelector('#pcBackfill').addEventListener('click', async ()=>{
    await ensurePing();
    await backfillRange(parseInt(bar.querySelector('#pcPerDay').value,10), parseInt(bar.querySelector('#pcLev').value,10), bar.querySelector('#pcSideMix').value, getRange());
  });

  bar.querySelector('#pcExport').addEventListener('click', exportJSON);
})();

function dateYMD(d){ return new Date(d).toISOString().slice(0,10); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function clampDom(){
  const bub = CHAT.querySelectorAll('.bub');
  const excess = Math.max(0, bub.length - DOM_CAP);
  for(let i=0;i<excess;i++) bub[i].remove();
}

/* Price cache */
const klinesCache = new Map();
async function ensurePing(){ try{ await fetch(API.ping, {cache:'no-store'}); }catch(e){} }
async function loadDailyKlines(symbol, startDate, endDate){
  const key = symbol + ':' + dateYMD(startDate) + ':' + dateYMD(endDate);
  if (klinesCache.has(key)) return klinesCache.get(key);
  const params = new URLSearchParams({
    symbol, interval:'1d',
    startTime: startDate.getTime(),
    endTime: endDate.getTime()
  });
  const res = await fetch(`${API.futuresKlines}?${params.toString()}`);
  if(!res.ok) throw new Error('Klines fetch failed for '+symbol);
  const data = await res.json();
  const slim = data.map(k => [k[0], parseFloat(k[1]), parseFloat(k[4])]); // [openTime, open, close]
  klinesCache.set(key, slim);
  return slim;
}
function priceOnDate(slimKlines, jsDate){
  const want = dateYMD(jsDate);
  const row = slimKlines.find(k=> dateYMD(k[0]) === want);
  if(!row) return null;
  return { open: row[1], close: row[2] };
}

/* Helpers */
function fmt2(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
function fmtPrice(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:3, maximumFractionDigits:5}); }
function roiBasePct({entry, last, side}){ const dir = (side==='LONG'? +1 : -1); return ((last - entry) / entry) * 100 * dir; }
function pickLeverageForRange(pctBase, min, max){
  if (pctBase <= 0) return null;
  let Lmin = Math.ceil(min / pctBase);
  let Lmax = Math.floor(max / pctBase);
  Lmin = Math.max(1, Lmin);
  Lmax = Math.min(125, Lmax);
  if (Lmin > Lmax) return null;
  return Math.floor(Math.random()*(Lmax - Lmin + 1)) + Lmin;
}
function randomSide(mode){ if (mode==='long') return 'LONG'; if (mode==='short') return 'SHORT'; return Math.random()<0.5?'LONG':'SHORT'; }

/* Ledger for export */
const ledger = [];

/* OLD card builder (unchanged) */
function makeProfitCardOld({side, leverage, symbol, entry, last, pct, ref}){
  const wrap = document.createElement('div');
  wrap.className = 'pcard';
  wrap.innerHTML = `
    <div class="inner">
      <div class="header">
        <img class="binance-logo" src="https://iili.io/KKRCyss.th.png" alt="Binance Logo" />
        <div class="text-block">
          <div class="binance-text">BINANCE</div>
          <div class="futures-text">FUTURES</div>
        </div>
      </div>
      <div class="trade-info">
        <span class="${side==='LONG'?'long':'short'}">${side==='LONG'?'Long':'Short'}</span>
        <span>|</span>
        <span>${leverage}x</span>
        <span>|</span>
        <span>${symbol} Perpetual</span>
      </div>
      <div class="percentage ${pct>=0?'green':'red'}">${pct>=0?'+':''}${pct.toFixed(2)}%</div>
      <div class="price-section">
        <div class="price-line"><span class="price-label">Entry Price</span><span class="price-value">${fmt2(entry)}</span></div>
        <div class="price-line"><span class="price-label">Last Price</span><span class="price-value">${fmt2(last)}</span></div>
      </div>
      <div class="referral-section">
        <img class="qr" src="https://iili.io/K1dUMml.jpg" alt="QR Code"/>
        <div>
          <div class="ref-text">Referral Code</div>
          <div class="referral-code">${ref}</div>
          <div class="app-text">Get the Binance App</div>
        </div>
      </div>
    </div>
  `;
  return wrap;
}

/* NEW card builder (>= 2025-07-25) — RANDOM bg + RANDOM ROI/USDT display */
function makeProfitCardNew({side, leverage, symbol, entry, last, roiPct, pnlUSDT, member, whenISO, ref}){
  const wrap = document.createElement('div');
  wrap.className = 'nx-card';
  wrap.style.background = `#111 url("${pickNewBg()}") center/cover no-repeat`;

  const showMode = pickDisplayMode(); // 'ROI' or 'USDT'
  const positive = (roiPct >= 0);
  const pnlLine = (showMode==='ROI')
    ? `<div class="nx-roi ${positive?'posG':'posR'}">${positive?'+':''}${roiPct.toFixed(2)}%</div><div class="nx-percent"></div>`
    : `<div class="nx-usd ${positive?'posG':'posR'}">${positive?'+':''}${fmt2(pnlUSDT)}</div><div class="nx-u">USDT</div>`;

  wrap.innerHTML = `
    <div class="nx-header">
      <div class="nx-av"><img src="https://iili.io/K10FPQ1.th.jpg" alt="${member.name}"></div>
      <div class="nx-user">
        <span class="nx-name">${member.name}</span>
        <span class="nx-time">${new Date(whenISO).toISOString().slice(0,19).replace('T',' ')}</span>
      </div>
    </div>

    <div class="nx-body">
      <div class="nx-title">${symbol} PERPETUAL</div>
      <div class="nx-pos">
        <span class="${side==='LONG'?'nx-long':'nx-short'}">${side==='LONG'?'Long':'Short'}</span>
        <span class="nx-div" aria-hidden="true"></span>
        <span class="nx-lev">${leverage}x</span>
      </div>

      <div class="nx-pnl">
        ${pnlLine}
      </div>

      <div class="nx-prices">
        <div class="nx-entry">
          <div class="nx-label">Entry Price</div>
          <div class="nx-value">${fmtPrice(entry)}</div>
        </div>
        <div class="nx-last">
          <div class="nx-label">Last Price</div>
          <div class="nx-value">${fmtPrice(last)}</div>
        </div>
      </div>
    </div>

    <div class="nx-foot">
      <span class="nx-line"></span>
      <div class="nx-footc">
        <div class="nx-id">
          <span class="nx-logo"><img src="https://iili.io/KBDmWsn.th.png" alt="Binance logo"></span>
          <span class="nx-brand">BINANCE</span>
          <span class="nx-futures">FUTURES</span>
          <span class="nx-ref">Referral Code ${ref}</span>
        </div>
        <span class="nx-qr">
          <img src="https://iili.io/K1dUMml.jpg" alt="QR Code">
        </span>
      </div>
    </div>
  `;
  return wrap;
}

/* Add a card bubble to chat */
function addAdminBubble(node, caption){
  const b = document.createElement('div'); b.className='bub admin';
  b.appendChild(node);
  if (caption){
    const p = document.createElement('div'); p.style.marginTop='8px'; p.textContent = caption;
    b.appendChild(p);
  }
  const m = document.createElement('div'); m.className='meta'; m.textContent = `Admin • ${new Date().toLocaleString()}`;
  b.appendChild(m);
  CHAT.appendChild(b);
  CHAT.scrollTop = CHAT.scrollHeight;
  clampDom();
}

/* Generators */
async function preloadRange(range){
  await Promise.all(SYMBOLS.map(s=>loadDailyKlines(s, range.start, range.end)));
}
async function generateCardsRandom(count, leverageHint, sideMix, range){
  await preloadRange(range);
  let made = 0, guard = 0;
  while (made < count && guard < count*300){
    guard++;
    const sym = pick(SYMBOLS);
    const day = new Date(range.start.getTime() + Math.random()*(range.end - range.start));
    day.setHours(0,0,0,0);

    const klKey = [...klinesCache.keys()].find(k=>k.startsWith(sym+':'));
    const kl = klinesCache.get(klKey);
    const px = priceOnDate(kl, day);
    if(!px) continue;

    let side = (function(){ if (sideMix==='long') return 'LONG'; if (sideMix==='short') return 'SHORT'; return Math.random()<0.5?'LONG':'SHORT'; })();

    const baseLong = roiBasePct({entry:px.open, last:px.close, side:'LONG'});
    const baseShort = roiBasePct({entry:px.open, last:px.close, side:'SHORT'});
    if (side==='LONG' && baseLong<=0 && baseShort>0) side='SHORT';
    if (side==='SHORT' && baseShort<=0 && baseLong>0) side='LONG';
    const pctBase = side==='LONG'? baseLong : baseShort;
    if (pctBase<=0) continue;

    const lev = (function(pctBase,min,max){
      if (pctBase <= 0) return null;
      let Lmin = Math.ceil(min / pctBase);
      let Lmax = Math.floor(max / pctBase);
      Lmin = Math.max(1, Lmin);
      Lmax = Math.min(125, Lmax);
      if (Lmin > Lmax) return null;
      return Math.floor(Math.random()*(Lmax - Lmin + 1)) + Lmin;
    })(pctBase, ROI_RANGE.min, ROI_RANGE.max);
    if (!lev) continue;

    const entry = px.open, last = px.close;
    const roiPct = pctBase * lev;                 // leveraged ROI %
    const ref = String(Math.floor(100000000 + Math.random()*900000000));
    const member = members[(Math.random()*members.length)|0];
    const notional = 100 + Math.random()*900;     // 100..1000 USDT
    const pnlUSDT = notional * (roiPct/100);      // USDT PnL derived from ROI%

    const isNew = (day >= CUTOFF_NEW);
    const cardNode = isNew
      ? makeProfitCardNew({side, leverage:lev, symbol:sym, entry, last, roiPct, pnlUSDT, member, whenISO:day.toISOString(), ref})
      : makeProfitCardOld({side, leverage:lev, symbol:sym, entry, last, pct:roiPct, ref});

    const caption = `${member.name} • ${sym} • ${side} • ${lev}x • ${dateYMD(day)} ${isNew?'• NEW':'• OLD'}`;
    addAdminBubble(cardNode, caption);

    ledger.push({
      date: dateYMD(day), member:member.name,
      symbol:sym, side, leverage:lev, entry, last,
      roi_pct:roiPct, pnl_usdt:pnlUSDT, referral:ref, template:isNew?'new':'old'
    });
    made++;
    if (made % 10 === 0) await sleep(30);
  }
}

async function backfillRange(perDay, leverageHint, sideMix, range){
  await preloadRange(range);
  for (let t = range.start.getTime(); t <= range.end.getTime(); t += 86400000){
    const day = new Date(t);
    let made = 0, tries = 0;
    while (made < perDay && tries < perDay*100){
      tries++;
      const sym = SYMBOLS[tries % SYMBOLS.length];
      const klKey = [...klinesCache.keys()].find(k=>k.startsWith(sym+':'));
      const kl = klinesCache.get(klKey);
      const px = priceOnDate(kl, day);
      if(!px) continue;

      let side = (function(){ if (sideMix==='long') return 'LONG'; if (sideMix==='short') return 'SHORT'; return Math.random()<0.5?'LONG':'SHORT'; })();

      const baseLong = roiBasePct({entry:px.open, last:px.close, side:'LONG'});
      const baseShort = roiBasePct({entry:px.open, last:px.close, side:'SHORT'});
      if (side==='LONG' && baseLong<=0 && baseShort>0) side='SHORT';
      if (side==='SHORT' && baseShort<=0 && baseLong>0) side='LONG';
      const pctBase = side==='LONG'? baseLong : baseShort;
      if (pctBase<=0) continue;

      const lev = (function(pctBase,min,max){
        if (pctBase <= 0) return null;
        let Lmin = Math.ceil(min / pctBase);
        let Lmax = Math.floor(max / pctBase);
        Lmin = Math.max(1, Lmin);
        Lmax = Math.min(125, Lmax);
        if (Lmin > Lmax) return null;
        return Math.floor(Math.random()*(Lmax - Lmin + 1)) + Lmin;
      })(pctBase, ROI_RANGE.min, ROI_RANGE.max);
      if (!lev) continue;

      const entry = px.open, last = px.close;
      const roiPct = pctBase * lev;
      const ref = String(Math.floor(100000000 + Math.random()*900000000));
      const member = members[(Math.random()*members.length)|0];
      const notional = 100 + Math.random()*900;
      const pnlUSDT = notional * (roiPct/100);

      const isNew = (day >= CUTOFF_NEW);
      const cardNode = isNew
        ? makeProfitCardNew({side, leverage:lev, symbol:sym, entry, last, roiPct, pnlUSDT, member, whenISO:day.toISOString(), ref})
        : makeProfitCardOld({side, leverage:lev, symbol:sym, entry, last, pct:roiPct, ref});

      const caption = `${member.name} • ${sym} • ${side} • ${lev}x • ${dateYMD(day)} ${isNew?'• NEW':'• OLD'}`;
      addAdminBubble(cardNode, caption);

      ledger.push({
        date: dateYMD(day), member:member.name,
        symbol:sym, side, leverage:lev, entry, last,
        roi_pct:roiPct, pnl_usdt:pnlUSDT, referral:ref, template:isNew?'new':'old'
      });
      made++;
      if (made % 20 === 0) await sleep(50);
    }
    await sleep(120);
  }
}

/* Export */
function exportJSON(){
  const blob = new Blob([JSON.stringify(ledger,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `profit-cards-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
